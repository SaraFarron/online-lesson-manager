# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Online Lesson Manager

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        –°–ï–†–í–ï–† 1 (–æ—Å–Ω–æ–≤–Ω–æ–π)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  Frontend   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ           Backend (FastAPI)         ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                     ‚îÇ                           ‚îÇ
‚îÇ                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ                      ‚îÇ         PostgreSQL          ‚îÇ            ‚îÇ
‚îÇ                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚ñ≤
                                     ‚îÇ HTTPS + API Key
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   –°–ï–†–í–ï–† 2 (–¥—Ä—É–≥–∞—è —Å—Ç—Ä–∞–Ω–∞)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ   Telegram Bot (aiogram) + Cache + Circuit Breaker      ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –ß–∞—Å—Ç—å 1: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏)
- [ ] –ß–∞—Å—Ç—å 2: Health checks
- [ ] –ß–∞—Å—Ç—å 3: –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –ß–∞—Å—Ç—å 4: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ß–∞—Å—Ç—å 5: Circuit Breaker + Cache (–≤ –±–æ—Ç–µ)
- [ ] –ß–∞—Å—Ç—å 6: –ë—ç–∫–∞–ø—ã PostgreSQL
- [ ] –ß–∞—Å—Ç—å 7: –î–µ–ø–ª–æ–π

---

## Backend Architecture: Event Scheduling

### Single Source of Truth Pattern

**–¶–µ–ª—å:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–ø—É–±–ª–∏—á–Ω—ã–µ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ) –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ª–æ–≥–∏–∫—É –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤.

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–æ—ë–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        _get_occupied_slots_for_day(user, day)                   ‚îÇ
‚îÇ     –ï–î–ò–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´ –î–õ–Ø –†–ê–°–ß–Å–¢–ê –ó–ê–ù–Ø–¢–´–• –°–õ–û–¢–û–í           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  1. –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (EventRepository.get_by_user)   ‚îÇ
‚îÇ     - –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ event.start.date() == day                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  2. –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —ç—Ç—É –¥–∞—Ç—É                   ‚îÇ
‚îÇ     (RecurrentEventRepository.get_for_date)                     ‚îÇ
‚îÇ     - –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ weekday                                      ‚îÇ
‚îÇ     - –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É –æ—Ç–º–µ–Ω (RecurrentCancels)                 ‚îÇ
‚îÇ     - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç interval_end (–¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π)        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ Event | RecurrentEvent       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                   ‚îÇ
         ‚ñº                   ‚ñº
   get_schedule       get_free_slots
   (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç        (–≤—ã—á–∏—Å–ª—è–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–µ
    —Å–æ–±—ã—Ç–∏—è)           —Å–ª–æ—Ç—ã –∏–∑ —Å–æ–±—ã—Ç–∏–π)
         ‚îÇ                   ‚îÇ
         ‚ñº                   ‚ñº
get_schedule_range   get_free_slots_range
(–≤—ã–∑—ã–≤–∞–µ—Ç SSOT       (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç
 –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è)     get_schedule_range)
         ‚îÇ                   ‚îÇ
         ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     –í—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:           ‚îÇ
‚îÇ  - GET /schedule/day                   ‚îÇ
‚îÇ  - GET /schedule/range                 ‚îÇ
‚îÇ  - GET /schedule/free-slots/day        ‚îÇ
‚îÇ  - GET /schedule/free-slots/range      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–¥–ª—è –±–æ—Ç–∞):   ‚îÇ
‚îÇ  - GET /internal/schedule/{telegram_id}‚îÇ
‚îÇ    (—á–µ—Ä–µ–∑ BotCacheService ‚Üí            ‚îÇ
‚îÇ     EventService.get_schedule_range &  ‚îÇ
‚îÇ     get_free_slots_range)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

**1. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏**
- –ú–µ—Ç–æ–¥ `_get_occupied_slots_for_day()` ‚Äî **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ** –º–µ—Å—Ç–æ, –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è, –∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ –∫–æ—Å–≤–µ–Ω–Ω–æ

**2. –†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è ‚Äî –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏**
- –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–ø–æ weekday, —Å –æ—Ç–º–µ–Ω–∞–º–∏) –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤ `RecurrentEventRepository.get_for_date()`
- –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç —ç—Ç—É –ª–æ–≥–∏–∫—É

**3. –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏**
- `/schedule/free-slots/day` –∏ `/internal/schedule/{telegram_id}` –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ–¥–Ω—É –∏ —Ç—É –∂–µ** –ª–æ–≥–∏–∫—É
- –ò—Å–∫–ª—é—á–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –≤ –¥–∞–Ω–Ω—ã—Ö

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª:** `app/services/events.py`

```python
async def _get_occupied_slots_for_day(
    self, user: User, day: date
) -> list[Event | RecurrentEvent]:
    """–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç—ã—Ö —Å–ª–æ—Ç–æ–≤."""
    events: list[Event | RecurrentEvent] = []
    
    # –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    for event in await self.repository.get_by_user(user):
        if event.start.date() == day:
            events.append(event)
    
    # –†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (—Å —É—á—ë—Ç–æ–º –æ—Ç–º–µ–Ω)
    recurrent_events = await self.recurrent_repo.get_for_date(user, day)
    events.extend(recurrent_events)
    
    return events

async def get_schedule(self, user: User, day: date):
    """–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å ‚Äî –ø—Ä—è–º–æ –∏–∑ SSOT."""
    return await self._get_occupied_slots_for_day(user, day)

async def get_free_slots(self, user: User, day: date):
    """–°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º –∏–∑ SSOT."""
    events = await self._get_occupied_slots_for_day(user, day)
    start, end = await self._get_working_hours(user)
    return self._filter_out_occupied_slots(events, start, end)
```

**–§–∞–π–ª:** `app/repositories/events.py`

```python
async def get_for_date(
    self, user: User, target_date: date
) -> list[RecurrentEvent]:
    """–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π —Å —É—á—ë—Ç–æ–º –æ—Ç–º–µ–Ω."""
    recurrent_events = await self.get_by_user(user)
    
    # –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–º–µ–Ω—ã
    recurrent_cancels = await self.cancels_repo.get_cancels_by_recurrent_events(
        [event.id for event in recurrent_events]
    )
    
    # –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –¥–∞—Ç–µ –æ—Ç–º–µ–Ω—ã
    day_cancels = {
        cancel.recurrent_event_id
        for cancel in recurrent_cancels
        if cancel.canceled_date.date() == target_date
    }
    
    # –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ weekday –∏ –æ—Ç–º–µ–Ω–∞–º
    matching_events = []
    for event in recurrent_events:
        if event.id in day_cancels:
            continue
        if event.start.date() > target_date:
            continue
        if event.start.weekday() != target_date.weekday():
            continue
        if event.interval_end and event.interval_end.date() < target_date:
            continue
        matching_events.append(event)
    
    return matching_events
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª:** `tests/test_schedule.py`

–ö–ª–∞—Å—Å `TestConsistencyBetweenEndpoints` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:
- ‚úÖ `/schedule/free-slots/day` ‚â° `/schedule/free-slots/range` (–¥–ª—è –æ–¥–Ω–æ–π –¥–∞—Ç—ã)
- ‚úÖ `/schedule/day` ‚â° `/schedule/range` (–¥–ª—è –æ–¥–Ω–æ–π –¥–∞—Ç—ã)
- ‚úÖ –°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã —É—á–∏—Ç—ã–≤–∞—é—Ç **–≤—Å–µ** —Å–æ–±—ã—Ç–∏—è (—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ + —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ)
- ‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **–≤—Å–µ** —Å–æ–±—ã—Ç–∏—è (—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ + —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ)

#### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ

**Bug #1:** –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç –≤ `get_free_slots_range()`
```python
# ‚ùå –ë—ã–ª–æ (naive datetime vs aware datetime)
if datetime.fromisoformat(day_str) < datetime.now():

# ‚úÖ –°—Ç–∞–ª–æ (date vs date)
if date.fromisoformat(day_str) < datetime.now(UTC).date():
```

**Bug #2:** –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞: –ª–æ–≥–∏–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–ª–∞—Å—å –≤ `get_schedule()` –∏ `get_schedule_range()`
- –ü–æ—Å–ª–µ: –≤—Å—è –ª–æ–≥–∏–∫–∞ –≤ `RecurrentEventRepository.get_for_date()`

**Bug #3:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –æ—Ç–º–µ–Ω –≤ `RecurrentCancelsRepository`
```python
# ‚ùå –ë—ã–ª–æ
RecurrentCancels.id.in_(recurrent_event_ids)

# ‚úÖ –°—Ç–∞–ª–æ
RecurrentCancels.recurrent_event_id.in_(recurrent_event_ids)
```

---

## –ß–∞—Å—Ç—å 1: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏

**–¶–µ–ª—å:** –ó–∞—â–∏—Ç–∏—Ç—å API –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å.

### Backend

**–§–∞–π–ª:** `app/core/config.py`
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ Settings:
telegram_bot_api_key: str  # –ö–ª—é—á –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–æ—Ç–∞
```

**–§–∞–π–ª:** `app/api/deps.py`
```python
# –î–æ–±–∞–≤–∏—Ç—å dependency –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–ª—é—á–∞:
# - –ß–∏—Ç–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Service-Key
# - –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å settings.telegram_bot_api_key
# - –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí 403 Forbidden
```

**–§–∞–π–ª:** `app/api/v1/endpoints/internal.py` (–Ω–æ–≤—ã–π)
```python
# –í—Å–µ internal endpoints –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç—É dependency
# –ü—Ä–∏–º–µ—Ä: @router.get("/notifications/pending", dependencies=[Depends(verify_service_key)])
```

### Telegram Bot

```python
# –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ backend –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫:
headers={"X-Service-Key": config.BACKEND_API_KEY}
```

### Environment Variables

```env
# Backend (.env)
TELEGRAM_BOT_API_KEY=—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å-–¥–ª–∏–Ω–Ω—ã–π-—Å–ª—É—á–∞–π–Ω—ã–π-–∫–ª—é—á

# Telegram Bot (.env)  
BACKEND_API_KEY=—Ç–æ—Ç-–∂–µ-—Å–∞–º—ã–π-–∫–ª—é—á
BACKEND_URL=https://api.example.com
```

**–ö–∞–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á:**
```bash
openssl rand -hex 32
```

---

## –ß–∞—Å—Ç—å 2: Health Checks

**–¶–µ–ª—å:** –ü–æ–Ω–∏–º–∞—Ç—å, –∂–∏–≤ –ª–∏ —Å–µ—Ä–≤–∏—Å. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ Docker healthcheck.

### Backend

**–§–∞–π–ª:** `app/api/v1/endpoints/health.py`

Endpoint: `GET /api/v1/health`

–õ–æ–≥–∏–∫–∞:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î (`SELECT 1`)
2. –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç—É—Å: `healthy` / `unhealthy`
3. –í–µ—Ä–Ω—É—Ç—å –¥–µ—Ç–∞–ª–∏: database connected/error

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
```json
{
  "status": "healthy",
  "database": "connected",
  "timestamp": "2026-01-16T12:00:00Z"
}
```

### Docker

**–§–∞–π–ª:** `docker-compose.yml`

–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ—Ä–≤–∏—Å `api`:
```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
  interval: 30s
  timeout: 10s
  retries: 3
```

---

## –ß–∞—Å—Ç—å 3: –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–¶–µ–ª—å:** –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–± —É—Ä–æ–∫–∞—Ö —á–µ—Ä–µ–∑ Telegram. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–Ω—ã —Ç–µ—Ä—è—Ç—å—Å—è.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Backend —Å–æ–∑–¥–∞—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î (status=pending)
                                      ‚Üì
–ë–æ—Ç –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫: GET /internal/notifications/pending
                                      ‚Üì
–ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram ‚Üí PATCH /internal/notifications/{id} (status=sent)
```

### Backend

**–§–∞–π–ª:** `app/models/notification.py` (–Ω–æ–≤—ã–π)

–¢–∞–±–ª–∏—Ü–∞ `notifications`:
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | int | PK |
| telegram_user_id | bigint | –ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å |
| message | text | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è |
| scheduled_at | datetime | –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å |
| status | enum | pending / sent / failed |
| attempts | int | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (max 3) |
| created_at | datetime | –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–Ω–æ |

**–§–∞–π–ª:** `app/services/notification.py` (–Ω–æ–≤—ã–π)

–ú–µ—Ç–æ–¥—ã:
- `schedule_lesson_reminder(lesson)` ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 1 —á–∞—Å –¥–æ —É—Ä–æ–∫–∞
- `schedule_lesson_confirmation(lesson)` ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** `app/api/v1/endpoints/internal.py`

Endpoints (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–æ—Ç–∞, —Å `verify_service_key`):
- `GET /internal/notifications/pending` ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã–µ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ
- `PATCH /internal/notifications/{id}` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å

### Telegram Bot

**–§–∞–π–ª:** `services/notification_fetcher.py` (–Ω–æ–≤—ã–π)

–õ–æ–≥–∏–∫–∞:
1. –¶–∏–∫–ª –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
2. `GET /internal/notifications/pending`
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
   - `bot.send_message(chat_id, text)`
   - `await asyncio.sleep(0.1)` ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è rate limit
   - `PATCH` —Å—Ç–∞—Ç—É—Å –Ω–∞ `sent`
4. –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –ø–æ–ø—Ä–æ–±—É–µ—Ç —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫

### –ú–∏–≥—Ä–∞—Ü–∏—è

```bash
alembic revision -m "add_notifications_table"
```

---

## –ß–∞—Å—Ç—å 4: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¶–µ–ª—å:** –ü–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Å–∏—Å—Ç–µ–º–µ. –í–∏–¥–µ—Ç—å –æ—à–∏–±–∫–∏ –±–µ–∑ SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

### Backend

**–§–∞–π–ª:** `app/core/logging.py` (–Ω–æ–≤—ã–π)

–ù–∞—Å—Ç—Ä–æ–π–∫–∏:
- –§–æ—Ä–º–∞—Ç: JSON (–¥–ª—è –±—É–¥—É—â–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞)
- –£—Ä–æ–≤–µ–Ω—å: INFO –¥–ª—è production, DEBUG –¥–ª—è development
- –í—ã–≤–æ–¥: stdout (Docker —Å–æ–±–µ—Ä—ë—Ç)

–ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:
- –ö–∞–∂–¥—ã–π HTTP –∑–∞–ø—Ä–æ—Å (–º–µ—Ç–æ–¥, path, status, –≤—Ä–µ–º—è)
- –û—à–∏–±–∫–∏ —Å traceback
- –í–∞–∂–Ω—ã–µ –±–∏–∑–Ω–µ—Å-—Å–æ–±—ã—Ç–∏—è (—É—Ä–æ–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω, –æ—Ç–º–µ–Ω—ë–Ω)

**–§–∞–π–ª:** `app/main.py`

–î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤.

### Telegram Bot

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ:
- –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ó–∞–ø—Ä–æ—Å—ã –∫ backend (URL, status, –≤—Ä–µ–º—è)
- –û—à–∏–±–∫–∏

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
docker compose logs -f api
docker compose logs -f bot
```

---

## –ß–∞—Å—Ç—å 5: Circuit Breaker + Cache (Telegram Bot)

**–¶–µ–ª—å:** –ë–æ—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∑—ã–≤—á–∏–≤—ã–º –¥–∞–∂–µ –∫–æ–≥–¥–∞ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```
pip install circuitbreaker cachetools httpx
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
telegram/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ backend_client.py    # HTTP –∫–ª–∏–µ–Ω—Ç —Å Circuit Breaker
‚îÇ   ‚îî‚îÄ‚îÄ cache.py             # TTL –∫—ç—à
```

### Cache

**–§–∞–π–ª:** `services/cache.py`

```python
from cachetools import TTLCache

class BotCache:
    schedule = TTLCache(maxsize=100, ttl=300)      # 5 –º–∏–Ω—É—Ç
    student_lessons = TTLCache(maxsize=500, ttl=120)  # 2 –º–∏–Ω—É—Ç—ã
```

–ü—Ä–∞–≤–∏–ª–∞:
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ READ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ü–æ—Å–ª–µ WRITE (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—Ç–º–µ–Ω–∞) ‚Üí –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à
- –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API ‚Üí –æ—Ç–¥–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ (–ª—É—á—à–µ, —á–µ–º –Ω–∏—á–µ–≥–æ)

### Circuit Breaker

**–§–∞–π–ª:** `services/backend_client.py`

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `failure_threshold=5` ‚Äî –ø–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫ —Ä–∞–∑–º—ã–∫–∞–µ–º
- `recovery_timeout=60` ‚Äî —á–µ—Ä–µ–∑ 60 —Å–µ–∫ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞

–õ–æ–≥–∏–∫–∞:
1. –ó–∞–ø—Ä–æ—Å –∫ API
2. –£—Å–ø–µ—Ö ‚Üí –≤–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
3. –û—à–∏–±–∫–∞ ‚Üí –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–∞ –æ—à–∏–±–æ–∫
4. 5 –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥ ‚Üí Circuit OPEN
5. –°–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã ‚Üí —Å—Ä–∞–∑—É `CircuitBreakerError` (–Ω–µ –∂–¥—ë–º timeout)
6. –ß–µ—Ä–µ–∑ 60 —Å–µ–∫ ‚Üí –æ–¥–∏–Ω –ø—Ä–æ–±–Ω—ã–π –∑–∞–ø—Ä–æ—Å
7. –£—Å–ø–µ—Ö ‚Üí Circuit CLOSED, —Ä–∞–±–æ—Ç–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö

```python
@router.message(F.text == "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
async def show_schedule(message: Message):
    schedule = await backend_client.get_schedule(teacher_id=1)
    
    if schedule is None:
        await message.answer("‚ö†Ô∏è –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        return
    
    if schedule.get("_stale"):
        await message.answer(f"‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã\n\n{format(schedule)}")
    else:
        await message.answer(format(schedule))
```

---

## –ß–∞—Å—Ç—å 6: –ë—ç–∫–∞–ø—ã PostgreSQL

**–¶–µ–ª—å:** –ù–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å–±–æ–µ.

### –°–∫—Ä–∏–ø—Ç

**–§–∞–π–ª:** `scripts/backup.sh`

```bash
#!/bin/bash
BACKUP_DIR="/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
CONTAINER_NAME="backend-db-1"  # –∏–ª–∏ –∫–∞–∫ —É —Ç–µ–±—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è

docker exec $CONTAINER_NAME pg_dump -U postgres lesson_manager | gzip > "$BACKUP_DIR/backup_$TIMESTAMP.sql.gz"

# –£–¥–∞–ª–∏—Ç—å –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

### Cron

```bash
# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
0 3 * * * /path/to/scripts/backup.sh
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
gunzip < backup_20260116_030000.sql.gz | docker exec -i backend-db-1 psql -U postgres lesson_manager
```

---

## –ß–∞—Å—Ç—å 7: –î–µ–ø–ª–æ–π

### –°–µ—Ä–≤–µ—Ä 1 (Backend + Frontend)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
/opt/online-lesson-manager/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îî‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ scripts/
    ‚îî‚îÄ‚îÄ backup.sh
```

**Docker Compose (production):**

–ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è production:
- –£–±—Ä–∞—Ç—å `--reload`
- –£–±—Ä–∞—Ç—å volume mount –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å restart: always
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–æ–º–µ–Ω

**Reverse Proxy (nginx/caddy):**
- HTTPS —Ç–µ—Ä–º–∏–Ω–∞—Ü–∏—è
- –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ backend:8000
- –°—Ç–∞—Ç–∏–∫–∞ frontend

### –°–µ—Ä–≤–µ—Ä 2 (Telegram Bot)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
/opt/telegram-bot/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env
‚îî‚îÄ‚îÄ src/
```

**Environment:**
```env
BACKEND_URL=https://api.example.com
BACKEND_API_KEY=–∫–ª—é—á-–∏–∑-—á–∞—Å—Ç–∏-1
TELEGRAM_BOT_TOKEN=—Ç–æ–∫–µ–Ω-–±–æ—Ç–∞
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ

**–ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (–ø–æ–∫–∞ –±–µ–∑ CI/CD):**

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /opt/online-lesson-manager/backend
git pull
docker compose build
docker compose up -d

# –ú–∏–≥—Ä–∞—Ü–∏–∏
docker compose run --rm migrate
```

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

```
–ù–µ–¥–µ–ª—è 1:
‚îú‚îÄ‚îÄ –ß–∞—Å—Ç—å 1: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2-3 —á–∞—Å–∞)
‚îú‚îÄ‚îÄ –ß–∞—Å—Ç—å 2: Health checks (1 —á–∞—Å)
‚îî‚îÄ‚îÄ –ß–∞—Å—Ç—å 6: –ë—ç–∫–∞–ø—ã (1 —á–∞—Å)

–ù–µ–¥–µ–ª—è 2:
‚îú‚îÄ‚îÄ –ß–∞—Å—Ç—å 4: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (2-3 —á–∞—Å–∞)
‚îî‚îÄ‚îÄ –ß–∞—Å—Ç—å 3: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (4-6 —á–∞—Å–æ–≤)

–ù–µ–¥–µ–ª—è 3:
‚îú‚îÄ‚îÄ –ß–∞—Å—Ç—å 5: Circuit Breaker + Cache (3-4 —á–∞—Å–∞)
‚îî‚îÄ‚îÄ –ß–∞—Å—Ç—å 7: –î–µ–ø–ª–æ–π (2-4 —á–∞—Å–∞)
```

---

## –ù—é–∞–Ω—Å—ã –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

### Telegram Rate Limits
- –ù–µ –±–æ–ª–µ–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
- –î–æ–±–∞–≤–ª—è–π `await asyncio.sleep(0.05)` –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –ü—Ä–∏ 429 –æ—à–∏–±–∫–µ ‚Äî —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –¥–≤—É—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö
- –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
- –ü–æ—Ç–æ–º –æ–±–Ω–æ–≤–∏—Ç—å backend
- –ü–æ—Ç–æ–º –æ–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
- –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å backward-compatible

### –ß–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞
- –•—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –≤ UTC
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —É—á–∏—Ç–µ–ª—è —Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ timezone

### CORS
- –í production —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–æ–º–µ–Ω frontend
- –ù–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å `allow_origins=["*"]`

### –°–µ–∫—Ä–µ—Ç—ã
- –ù–µ –∫–æ–º–º–∏—Ç–∏—Ç—å .env —Ñ–∞–π–ª—ã
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è dev/prod
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Ä–æ—Ç–∏—Ä–æ–≤–∞—Ç—å API –∫–ª—é—á–∏
